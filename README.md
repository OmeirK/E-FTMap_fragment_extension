## Introduction

   This repository contains the code for guiding fragment expansion using results from the 
   [E-FTMap web server](https://eftmap.bu.edu/). The protocol is designed to screen the 
   Enamine REAL library by default, however any custom chemical database can be used.

## Installation
   
   Install the dependencies for running the code with:
   ```
   conda env create --file eftmap_vs.yaml
   ```

   Next, download the Enamine REAL database from the [Enamine website](https://enamine.net/compound-collections/real-compounds/real-database).

## Required Inputs
   
   To run the pipeline, the following inputs are required:

   1) A .mol file containing the fragment you wish to extend
   2) A .pdb file of the receptor that the fragment is bound to
   3) An E-FTMap ```_pharm.pdb``` file generated by mapping the receptor .pdb
   4) A .txt file containing a SMARTS pattern

   The code protocol is split into three distinct steps:
   1) 2-dimensional screening of the Enamine REAL database ```01_2d_screening/```
   2) 3-dimensional filtering of 2D hits using template based docking ```02_3d_filtering/```
   3) Scoring and processing docked hits ```03_E-FTMap_scoring```

   Example data is provided in the ```example_data/``` directory.

## Running the 2D Screen

   To run 2D filtering run the following command:
   ```
   python3 01_2d_screening/01_2d_stage_1.py -l=example_data/dyrk1a_smarts.txt -o=results_2d_hits -db=/path/to/enamine/installation
   ```
   Based on the number of SMARTS patterns provided, the 2D screen will take 2-4 days on a single CPU.


## Processing the 2D Screen

   Typically, we recommend filtering 2D hits on the basis of their size and flexibility to control the size and complexity of extended moities.
   This step not only reduces the size of the 2D hits that need to be advanced to the more computationally expensive 3D stage, but also ensures that highly flexible ligands will not be modeled. In the context of template-based docking, large numbers of rotatable bonds can increase both computational cost and the likelihood of producing incorrect results.
   
   In this example, we will sort hits to contain compounds with 0-25 heavy atoms and up to 2 new rotatble bonds:
   ```
   python3 01_2d_screening/util01_Py_collect_2d_screen_stats_v2.py -s=results_2d_hits/anchor_1/2d_stage_1.txt -od=sorted_2d_hits_anchor_1
   python3 01_2d_screening/util02_Py_collect_hit_subset_v2.py -m=example_data/7A4R_A_aligned_QY8_501.mol -sd=sorted_2d_hits_anchor_1 -o=filtered_hits_0-25HAC_2nb.tsv -nb 2 -maxhac 25 -minhac 0
   ```

## Running 3D filtering
   
   After selecting a subset of 2D hits to advance, we can run 3D filtering to identify ligands that fit within the receptor pocket.
   
   If it is your first time running the code, edit the following line in 02_3d_filtering/02_Py_run_3d_placement_v3_norandcoord.py to match your installation path:
   ```
   CMD_PATH='/projectnb/docking/omeir/E-FTMAP_molecular_stitching/git_repo/E-FTMap_fragment_extension/02_3d_filtering/'
   ```

   Then, run the 3D filtering code using the following command:
   ```
   python3 02_3d_filtering/02_Py_run_3d_placement_v3_norandcoord.py -f=filtered_hits_0-25HAC_2nb.tsv -r=example_data/7A4R_A_rec.pdb -l=example_data/7A4R_A_aligned_QY8_501.mol -od=anchor_1_3d_hits -cpu=1
   ```

